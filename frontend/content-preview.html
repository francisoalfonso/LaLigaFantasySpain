<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Preview Contenido Redes Sociales - Fantasy La Liga</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
        /* Instagram mockup styles */
        .instagram-post {
            max-width: 470px;
            background: white;
            border: 1px solid #dbdbdb;
            border-radius: 8px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }

        .instagram-header {
            padding: 14px 16px;
            display: flex;
            align-items: center;
            border-bottom: 1px solid #efefef;
        }

        .instagram-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            margin-right: 12px;
            border: 2px solid #e1306c;
        }

        .instagram-username {
            font-weight: 600;
            font-size: 14px;
            color: #262626;
        }

        .instagram-image-container {
            position: relative;
            padding-bottom: 125%; /* 4:5 ratio */
            background: #f0f0f0;
            overflow: hidden;
        }

        .instagram-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .instagram-actions {
            padding: 8px 16px;
            border-bottom: 1px solid #efefef;
        }

        .instagram-action-btn {
            background: none;
            border: none;
            font-size: 24px;
            margin-right: 16px;
            cursor: pointer;
        }

        .instagram-likes {
            padding: 0 16px;
            margin: 8px 0;
            font-size: 14px;
            font-weight: 600;
        }

        .instagram-caption {
            padding: 0 16px 16px;
            font-size: 14px;
            line-height: 18px;
            color: #262626;
        }

        .instagram-caption-username {
            font-weight: 600;
            margin-right: 6px;
        }

        .instagram-hashtag {
            color: #00376b;
            cursor: pointer;
        }

        .instagram-timestamp {
            padding: 0 16px 16px;
            font-size: 10px;
            color: #8e8e8e;
            text-transform: uppercase;
        }

        .player-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 24px;
            border-radius: 16px;
            color: white;
            position: relative;
            overflow: hidden;
        }

        .player-card::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 300px;
            height: 300px;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
        }

        .chollo-badge {
            background: #ff3b30;
            color: white;
            padding: 8px 16px;
            border-radius: 24px;
            font-weight: bold;
            font-size: 14px;
            display: inline-block;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .stat-item {
            background: rgba(255, 255, 255, 0.2);
            padding: 12px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            display: block;
        }

        .stat-label {
            font-size: 12px;
            opacity: 0.9;
        }

        .video-mockup {
            position: relative;
            padding-bottom: 177.78%; /* 9:16 ratio */
            background: #000;
            border-radius: 12px;
            overflow: hidden;
        }

        .video-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.3);
        }

        .play-button {
            width: 64px;
            height: 64px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .play-button:hover {
            transform: scale(1.1);
        }

        .carousel-indicator {
            display: flex;
            justify-content: center;
            gap: 6px;
            padding: 12px 0;
        }

        .carousel-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #c7c7c7;
            transition: background 0.3s;
        }

        .carousel-dot.active {
            background: #0095f6;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div x-data="contentPreview()" x-init="init()">
        <!-- Header -->
        <header class="bg-gradient-to-r from-blue-600 to-purple-600 text-white py-6 shadow-lg">
            <div class="container mx-auto px-4">
                <h1 class="text-3xl font-bold flex items-center gap-3">
                    <span>üì±</span>
                    Preview Contenido Redes Sociales
                </h1>
                <p class="text-blue-100 mt-2">Simula y visualiza contenido antes de publicar</p>
            </div>
        </header>

        <!-- Main Content -->
        <main class="container mx-auto px-4 py-8">
            <!-- Loading -->
            <div x-show="loading" class="text-center py-12">
                <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-blue-600 mx-auto"></div>
                <p class="mt-4 text-gray-600">Cargando preview...</p>
            </div>

            <!-- Error -->
            <div x-show="error" class="bg-red-50 border border-red-200 text-red-800 p-4 rounded-lg mb-6">
                <p class="font-semibold">‚ùå Error:</p>
                <p x-text="error"></p>
            </div>

            <!-- Workflow Info -->
            <div x-show="!loading && workflowData" class="bg-white rounded-lg shadow-md p-6 mb-8">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-900" x-text="workflowData?.workflow"></h2>
                        <p class="text-gray-600">Workflow ID: <span class="font-mono text-sm" x-text="workflowData?.workflowId"></span></p>
                    </div>
                    <div class="text-right">
                        <p class="text-3xl font-bold text-green-600" x-text="workflowData?.chollosDetectados"></p>
                        <p class="text-sm text-gray-600">Chollos detectados</p>
                    </div>
                </div>

                <div class="flex gap-4 mt-4">
                    <button @click="loadPreview()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition flex items-center gap-2">
                        <span>üîÑ</span>
                        Recargar Preview
                    </button>
                    <button @click="exportAll()" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition flex items-center gap-2">
                        <span>üì•</span>
                        Exportar Todo
                    </button>
                </div>
            </div>

            <!-- Chollos Grid -->
            <div x-show="!loading && contenidoItems.length > 0" class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <template x-for="(item, index) in contenidoItems" :key="index">
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <!-- Chollo Header -->
                        <div class="mb-6">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-xl font-bold text-gray-900" x-text="item.player.name"></h3>
                                <span class="chollo-badge">üî• CHOLLO</span>
                            </div>

                            <div class="grid grid-cols-4 gap-4 mb-4">
                                <div class="stat-item bg-gradient-to-br from-blue-500 to-blue-600 text-white">
                                    <span class="stat-value" x-text="'‚Ç¨' + item.player.price + 'M'"></span>
                                    <span class="stat-label">Precio</span>
                                </div>
                                <div class="stat-item bg-gradient-to-br from-green-500 to-green-600 text-white">
                                    <span class="stat-value" x-text="item.player.valueRatio + 'x'"></span>
                                    <span class="stat-label">Ratio</span>
                                </div>
                                <div class="stat-item bg-gradient-to-br from-purple-500 to-purple-600 text-white">
                                    <span class="stat-value" x-text="item.player.estimatedPoints"></span>
                                    <span class="stat-label">Puntos</span>
                                </div>
                                <div class="stat-item bg-gradient-to-br from-yellow-500 to-yellow-600 text-white">
                                    <span class="stat-value" x-text="item.player.stats.rating"></span>
                                    <span class="stat-label">Rating</span>
                                </div>
                            </div>
                        </div>

                        <!-- Instagram Mockup -->
                        <div class="mb-6">
                            <h4 class="font-semibold text-gray-700 mb-3 flex items-center gap-2">
                                <span>üì±</span>
                                Preview Instagram
                            </h4>

                            <div class="instagram-post mx-auto">
                                <!-- Instagram Header -->
                                <div class="instagram-header">
                                    <img src="https://via.placeholder.com/32" alt="Avatar" class="instagram-avatar">
                                    <span class="instagram-username">laligafantasyspain</span>
                                    <button class="ml-auto text-xl">‚ãØ</button>
                                </div>

                                <!-- Instagram Video Ana Real -->
                                <div class="instagram-image-container" style="padding-bottom: 125%; position: relative; background: #000;">
                                    <!-- Video Ana Real Integrado -->
                                    <video
                                        :id="'video-' + index"
                                        class="instagram-image"
                                        style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover;"
                                        loop
                                        playsinline
                                        muted
                                        @click="toggleVideo($event, index)">
                                        <!-- Video de Ana Real (VEO3) -->
                                        <source :src="getAnaVideoUrl(item)" type="video/mp4">
                                        Tu navegador no soporta video HTML5
                                    </video>

                                    <!-- Overlay de Informaci√≥n sobre el Video -->
                                    <div class="absolute inset-0 pointer-events-none">
                                        <!-- Badge CHOLLO arriba -->
                                        <div class="absolute top-4 right-4 bg-red-600 text-white px-4 py-2 rounded-full font-bold text-sm shadow-lg animate-pulse">
                                            üî• CHOLLO
                                        </div>

                                        <!-- Informaci√≥n Player Bottom -->
                                        <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black via-black/80 to-transparent p-4 text-white">
                                            <div class="flex items-center gap-3 mb-2">
                                                <img :src="item.player.photo" class="w-12 h-12 rounded-full border-2 border-white" onerror="this.src='https://via.placeholder.com/48'">
                                                <div>
                                                    <h3 class="text-xl font-bold" x-text="item.player.name"></h3>
                                                    <p class="text-sm opacity-90" x-text="item.player.team + ' ‚Ä¢ ' + item.player.position"></p>
                                                </div>
                                            </div>

                                            <div class="flex justify-between items-center">
                                                <div class="flex gap-4 text-sm">
                                                    <div>
                                                        <span class="text-2xl font-bold" x-text="'‚Ç¨' + item.player.price + 'M'"></span>
                                                        <span class="opacity-75 ml-1">precio</span>
                                                    </div>
                                                    <div>
                                                        <span class="text-2xl font-bold text-green-400" x-text="item.player.valueRatio + 'x'"></span>
                                                        <span class="opacity-75 ml-1">valor</span>
                                                    </div>
                                                    <div>
                                                        <span class="text-2xl font-bold text-yellow-400" x-text="item.player.estimatedPoints"></span>
                                                        <span class="opacity-75 ml-1">pts</span>
                                                    </div>
                                                </div>

                                                <!-- Play/Pause Button -->
                                                <button @click="toggleVideo($event, index)" class="pointer-events-auto bg-white/20 backdrop-blur-sm p-3 rounded-full hover:bg-white/30 transition">
                                                    <svg :class="videoStates[index] ? 'hidden' : 'block'" class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
                                                        <path d="M6.3 2.841A1.5 1.5 0 004 4.11V15.89a1.5 1.5 0 002.3 1.269l9.344-5.89a1.5 1.5 0 000-2.538L6.3 2.84z"/>
                                                    </svg>
                                                    <svg :class="videoStates[index] ? 'block' : 'hidden'" class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
                                                        <path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v12a2 2 0 01-2 2H7a2 2 0 01-2-2V4z"/>
                                                    </svg>
                                                </button>
                                            </div>
                                        </div>

                                        <!-- Icono de sonido -->
                                        <button @click="toggleMute($event, index)" class="absolute top-4 left-4 pointer-events-auto bg-black/50 backdrop-blur-sm p-2 rounded-full hover:bg-black/70 transition">
                                            <svg :class="!muteStates[index] ? 'block' : 'hidden'" class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                                <path d="M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.707.707L4.586 13H2a1 1 0 01-1-1V8a1 1 0 011-1h2.586l3.707-3.707a1 1 0 011.09-.217zM12.293 7.293a1 1 0 011.414 0L15 8.586l1.293-1.293a1 1 0 111.414 1.414L16.414 10l1.293 1.293a1 1 0 01-1.414 1.414L15 11.414l-1.293 1.293a1 1 0 01-1.414-1.414L13.586 10l-1.293-1.293a1 1 0 010-1.414z"/>
                                            </svg>
                                            <svg :class="muteStates[index] ? 'block' : 'hidden'" class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                                <path d="M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.707.707L4.586 13H2a1 1 0 01-1-1V8a1 1 0 011-1h2.586l3.707-3.707a1 1 0 011.09-.217zM14.657 2.929a1 1 0 011.414 0A9.972 9.972 0 0119 10a9.972 9.972 0 01-2.929 7.071 1 1 0 01-1.414-1.414A7.971 7.971 0 0017 10c0-2.21-.894-4.208-2.343-5.657a1 1 0 010-1.414zm-2.829 2.828a1 1 0 011.415 0A5.983 5.983 0 0115 10a5.984 5.984 0 01-1.757 4.243 1 1 0 01-1.415-1.415A3.984 3.984 0 0013 10a3.983 3.983 0 00-1.172-2.828 1 1 0 010-1.415z"/>
                                            </svg>
                                        </button>
                                    </div>
                                </div>

                                <!-- Instagram Actions -->
                                <div class="instagram-actions">
                                    <button class="instagram-action-btn">‚ô•</button>
                                    <button class="instagram-action-btn">üí¨</button>
                                    <button class="instagram-action-btn">üì§</button>
                                    <button class="instagram-action-btn ml-auto">üîñ</button>
                                </div>

                                <!-- Instagram Likes -->
                                <div class="instagram-likes">
                                    <span x-text="Math.floor(Math.random() * 5000) + 1000"></span> Me gusta
                                </div>

                                <!-- Instagram Caption -->
                                <div class="instagram-caption">
                                    <span class="instagram-caption-username">laligafantasyspain</span>
                                    <span x-text="item.contenido.caption"></span>
                                </div>

                                <!-- Instagram Timestamp -->
                                <div class="instagram-timestamp">
                                    hace 2 horas
                                </div>
                            </div>
                        </div>

                        <!-- Info del Video -->
                        <div class="mb-4 bg-gradient-to-r from-purple-50 to-blue-50 p-4 rounded-lg border border-purple-200">
                            <h4 class="font-semibold text-gray-900 mb-2 flex items-center gap-2">
                                <span>üé¨</span>
                                Video Ana Real con VEO3
                            </h4>
                            <div class="grid grid-cols-3 gap-2 text-center text-sm">
                                <div class="bg-white p-2 rounded">
                                    <div class="font-bold text-purple-600">24s</div>
                                    <div class="text-xs text-gray-600">Duraci√≥n</div>
                                </div>
                                <div class="bg-white p-2 rounded">
                                    <div class="font-bold text-blue-600">9:16</div>
                                    <div class="text-xs text-gray-600">Formato</div>
                                </div>
                                <div class="bg-white p-2 rounded">
                                    <div class="font-bold text-green-600">$0.31</div>
                                    <div class="text-xs text-gray-600">Coste</div>
                                </div>
                            </div>
                            <p class="text-xs text-gray-600 mt-2">‚ú® Video integrado directamente en el post de Instagram con overlay de informaci√≥n</p>
                        </div>

                        <!-- Actions -->
                        <div class="flex gap-2 mt-4">
                            <button @click="approveContent(item)" class="flex-1 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition flex items-center justify-center gap-2">
                                <span>‚úÖ</span>
                                Aprobar y Publicar
                            </button>
                            <button @click="editContent(item)" class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition flex items-center justify-center gap-2">
                                <span>‚úèÔ∏è</span>
                                Editar
                            </button>
                        </div>
                    </div>
                </template>
            </div>
        </main>
    </div>

    <script>
        function contentPreview() {
            return {
                loading: true,
                error: null,
                workflowData: null,
                contenidoItems: [],
                videoStates: {}, // Track video playing states
                muteStates: {}, // Track mute states

                async init() {
                    await this.loadPreview();
                    // Auto-play first video after load
                    setTimeout(() => {
                        const firstVideo = document.getElementById('video-0');
                        if (firstVideo) {
                            firstVideo.play().catch(e => console.log('Autoplay prevented:', e));
                            this.videoStates[0] = true;
                        }
                    }, 1000);
                },

                async loadPreview() {
                    this.loading = true;
                    this.error = null;

                    try {
                        console.log('üöÄ Iniciando flujo completo REAL...');

                        // FLUJO COMPLETO REAL: Llamar al nuevo endpoint
                        const response = await fetch('/api/content-preview/generate-real-content', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        });
                        const data = await response.json();

                        if (!data.success) {
                            throw new Error(data.error || 'Error generando contenido real');
                        }

                        console.log('‚úÖ Contenido real generado:', data);

                        this.workflowData = {
                            workflow: data.data.metadata.workflow,
                            workflowId: 'YjvjMbHILQjUZjJz',
                            chollosDetectados: 1
                        };

                        // Montar contenido √∫nico real
                        this.contenidoItems = [{
                            id: 0,
                            player: {
                                name: data.data.player.name,
                                team: data.data.player.team,
                                position: data.data.player.position,
                                price: data.data.player.price,
                                valueRatio: data.data.player.valueRatio,
                                estimatedPoints: data.data.player.estimatedPoints,
                                photo: data.data.player.photo,
                                teamLogo: data.data.player.teamLogo,
                                stats: data.data.player.stats
                            },
                            contenido: {
                                caption: data.data.content.caption,
                                hashtags: data.data.content.hashtags,
                                mentions: data.data.content.mentions,
                                videoUrl: data.data.content.videoUrl,
                                platform: data.data.platform,
                                postType: data.data.postType
                            },
                            metadata: data.data.metadata,
                            performance: data.data.performance
                        }];

                        console.log('‚úÖ Preview montado con 1 contenido REAL');

                    } catch (error) {
                        console.error('‚ùå Error loading preview:', error);
                        this.error = error.message;
                    } finally {
                        this.loading = false;
                    }
                },

                toggleVideo(event, index) {
                    event.stopPropagation();
                    const video = document.getElementById(`video-${index}`);
                    if (video) {
                        if (video.paused) {
                            video.play();
                            this.videoStates[index] = true;
                        } else {
                            video.pause();
                            this.videoStates[index] = false;
                        }
                    }
                },

                toggleMute(event, index) {
                    event.stopPropagation();
                    const video = document.getElementById(`video-${index}`);
                    if (video) {
                        video.muted = !video.muted;
                        this.muteStates[index] = video.muted;
                    }
                },

                getAnaVideoUrl(item) {
                    // Si el contenido tiene videoUrl del backend, usarla
                    if (item.contenido && item.contenido.videoUrl) {
                        return item.contenido.videoUrl;
                    }

                    // Fallback: usar video por defecto
                    return '/output/veo3/ana-final-concatenated-simple.mp4';
                },

                approveContent(item) {
                    if (confirm(`¬øAprobar y publicar contenido de ${item.player.name}?`)) {
                        alert(`‚úÖ Contenido aprobado!\n\nSe publicar√° en Instagram:\n- Player card visual\n- Video Ana Real\n- Caption + Hashtags\n\nEn producci√≥n, esto activar√≠a el Workflow #2 de n8n.`);
                    }
                },

                editContent(item) {
                    alert(`‚úèÔ∏è Editor de contenido\n\nPuedes modificar:\n- Caption del post\n- Hashtags\n- Prompt del video Ana\n- Dise√±o del player card\n\n(Funcionalidad en desarrollo)`);
                },

                exportAll() {
                    const exportData = {
                        workflow: this.workflowData,
                        contenido: this.contenidoItems,
                        timestamp: new Date().toISOString()
                    };

                    const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.create('a');
                    a.href = url;
                    a.download = `content-preview-${Date.now()}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }
            }
        }
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🔍 Debug Grid Coordenadas API-Sports - Getafe</title>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.15);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: #2d3748;
            margin-bottom: 10px;
            font-size: 2.5rem;
        }

        .header p {
            color: #666;
            font-size: 1.1rem;
        }

        .debug-section {
            margin-bottom: 40px;
        }

        .debug-section h2 {
            color: #2d3748;
            margin-bottom: 20px;
            font-size: 1.8rem;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }

        .grid-matrix {
            background: #f7fafc;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .matrix-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        .matrix-table th,
        .matrix-table td {
            border: 2px solid #e2e8f0;
            padding: 12px;
            text-align: center;
            font-weight: 600;
        }

        .matrix-table th {
            background: #667eea;
            color: white;
            font-size: 1.1rem;
        }

        .matrix-table td {
            background: white;
            font-size: 0.9rem;
        }

        .player-cell {
            background: #48bb78 !important;
            color: white;
            font-size: 0.8rem;
            line-height: 1.2;
        }

        .raw-data {
            background: #1a202c;
            color: #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            font-family: 'Courier New', monospace;
            overflow-x: auto;
            margin-bottom: 20px;
        }

        .player-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .player-card {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .player-card.getafe {
            border-color: #3182ce;
            background: #ebf8ff;
        }

        .player-card.oviedo {
            border-color: #38a169;
            background: #f0fff4;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
            font-size: 1.2rem;
        }

        .error {
            background: #fed7d7;
            color: #c53030;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .controls {
            margin-bottom: 30px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn:hover {
            background: #5a67d8;
            transform: translateY(-2px);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: #667eea;
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .coordinate-analysis {
            background: #fff5f5;
            border: 2px solid #fc8181;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }

        .coordinate-analysis h3 {
            color: #c53030;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <div class="container" x-data="gridDebugApp()">
        <div class="header">
            <h1>🔍 Debug Grid Coordenadas API-Sports</h1>
            <p>Análisis detallado de las coordenadas de posicionamiento para Getafe vs Oviedo</p>
        </div>

        <div class="controls">
            <button class="btn" @click="loadFixtureData(1207658)">📊 Cargar Getafe vs Oviedo (1207658)</button>
            <button class="btn" @click="loadFixtureData(1207659)">🔄 Probar otro fixture</button>
            <button class="btn" @click="analyzeGrid()">🧮 Analizar Matriz</button>
        </div>

        <div x-show="loading" class="loading">
            🔄 Cargando datos de alineaciones...
        </div>

        <div x-show="error" class="error" x-text="error"></div>

        <div x-show="fixtureData && !loading">
            <!-- Estadísticas básicas -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" x-text="stats.totalPlayers"></div>
                    <div>Total Jugadores</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" x-text="stats.uniqueRows"></div>
                    <div>Filas Únicas (Rows)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" x-text="stats.uniqueCols"></div>
                    <div>Columnas Únicas (Cols)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" x-text="stats.gridRange"></div>
                    <div>Rango Grid</div>
                </div>
            </div>

            <!-- Matriz de coordenadas para Getafe -->
            <div class="debug-section" x-show="getafeMatrix">
                <h2>🔵 Matriz Getafe - Formación <span x-text="getafeFormation"></span></h2>
                <div class="grid-matrix">
                    <table class="matrix-table">
                        <thead>
                            <tr>
                                <th>Row/Col</th>
                                <template x-for="col in maxCols" :key="col">
                                    <th x-text="col"></th>
                                </template>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-for="row in maxRows" :key="row">
                                <tr>
                                    <th x-text="row"></th>
                                    <template x-for="col in maxCols" :key="col">
                                        <td
                                            :class="getMatrixCell(row, col, 'getafe') ? 'player-cell' : ''"
                                            x-text="getMatrixCell(row, col, 'getafe') || '-'"
                                        ></td>
                                    </template>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Matriz de coordenadas para Oviedo -->
            <div class="debug-section" x-show="oviedoMatrix">
                <h2>🟢 Matriz Oviedo - Formación <span x-text="oviedoFormation"></span></h2>
                <div class="grid-matrix">
                    <table class="matrix-table">
                        <thead>
                            <tr>
                                <th>Row/Col</th>
                                <template x-for="col in maxCols" :key="col">
                                    <th x-text="col"></th>
                                </template>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-for="row in maxRows" :key="row">
                                <tr>
                                    <th x-text="row"></th>
                                    <template x-for="col in maxCols" :key="col">
                                        <td
                                            :class="getMatrixCell(row, col, 'oviedo') ? 'player-cell' : ''"
                                            x-text="getMatrixCell(row, col, 'oviedo') || '-'"
                                        ></td>
                                    </template>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Lista detallada de jugadores -->
            <div class="debug-section">
                <h2>📋 Lista Detallada de Jugadores</h2>
                <div class="player-list">
                    <template x-for="player in allPlayers" :key="player.id">
                        <div class="player-card" :class="player.team.toLowerCase()">
                            <strong x-text="player.name"></strong><br>
                            <strong>Equipo:</strong> <span x-text="player.team"></span><br>
                            <strong>Posición:</strong> <span x-text="player.pos"></span><br>
                            <strong>Número:</strong> <span x-text="player.number"></span><br>
                            <strong>Grid:</strong> <span x-text="player.grid"></span><br>
                            <strong>Row:</strong> <span x-text="player.row"></span> |
                            <strong>Col:</strong> <span x-text="player.col"></span>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Análisis de coordenadas -->
            <div class="coordinate-analysis">
                <h3>🧮 Análisis de Patrones de Coordenadas</h3>
                <div x-show="analysis">
                    <p><strong>Patrón detectado:</strong> <span x-text="analysis.pattern"></span></p>
                    <p><strong>Rango de filas:</strong> <span x-text="analysis.rowRange"></span></p>
                    <p><strong>Rango de columnas:</strong> <span x-text="analysis.colRange"></span></p>
                    <p><strong>Distribución por filas:</strong></p>
                    <div x-show="analysis.rowDistribution">
                        <template x-for="(count, row) in analysis.rowDistribution" :key="row">
                            <div>Fila <span x-text="row"></span>: <span x-text="count"></span> jugadores</div>
                        </template>
                    </div>
                </div>
            </div>

            <!-- Datos raw de la API -->
            <div class="debug-section">
                <h2>🔧 Datos Raw de la API</h2>
                <div class="raw-data">
                    <pre x-text="JSON.stringify(fixtureData, null, 2)"></pre>
                </div>
            </div>
        </div>
    </div>

    <script>
        function gridDebugApp() {
            return {
                loading: false,
                error: null,
                fixtureData: null,
                getafeMatrix: {},
                oviedoMatrix: {},
                getafeFormation: '',
                oviedoFormation: '',
                maxRows: 5,
                maxCols: 5,
                allPlayers: [],
                stats: {},
                analysis: null,

                async loadFixtureData(fixtureId) {
                    this.loading = true;
                    this.error = null;

                    try {
                        console.log(`🔍 Cargando datos del fixture ${fixtureId}...`);

                        const response = await fetch(`/api/laliga/lineups/fixture/${fixtureId}`);
                        const data = await response.json();

                        if (!data.success) {
                            throw new Error(data.error || 'Error al cargar datos');
                        }

                        this.fixtureData = data.data;
                        this.processLineupData();
                        this.calculateStats();

                        console.log('✅ Datos cargados correctamente:', this.fixtureData);

                    } catch (err) {
                        console.error('❌ Error cargando datos:', err);
                        this.error = `Error: ${err.message}`;
                    } finally {
                        this.loading = false;
                    }
                },

                processLineupData() {
                    if (!this.fixtureData || this.fixtureData.length < 2) {
                        this.error = 'Datos de alineación incompletos';
                        return;
                    }

                    // Reset matrices
                    this.getafeMatrix = {};
                    this.oviedoMatrix = {};
                    this.allPlayers = [];

                    let maxRow = 0;
                    let maxCol = 0;

                    // Procesar ambos equipos
                    this.fixtureData.forEach(teamData => {
                        const teamName = teamData.team.name;
                        const isGetafe = teamName.toLowerCase().includes('getafe');
                        const matrix = isGetafe ? this.getafeMatrix : this.oviedoMatrix;

                        if (isGetafe) {
                            this.getafeFormation = teamData.formation;
                        } else {
                            this.oviedoFormation = teamData.formation;
                        }

                        // Procesar jugadores titulares
                        teamData.startXI.forEach(playerData => {
                            const player = playerData.player;
                            const grid = player.grid;

                            if (grid && grid.includes(':')) {
                                const [rowStr, colStr] = grid.split(':');
                                const row = parseInt(rowStr);
                                const col = parseInt(colStr);

                                maxRow = Math.max(maxRow, row);
                                maxCol = Math.max(maxCol, col);

                                // Almacenar en matriz
                                if (!matrix[row]) matrix[row] = {};
                                matrix[row][col] = `${player.number}. ${player.name.split(' ')[0]}`;

                                // Agregar a lista de todos los jugadores
                                this.allPlayers.push({
                                    id: player.id,
                                    name: player.name,
                                    number: player.number,
                                    pos: player.pos,
                                    grid: grid,
                                    row: row,
                                    col: col,
                                    team: teamName
                                });
                            }
                        });
                    });

                    this.maxRows = Math.max(5, maxRow);
                    this.maxCols = Math.max(5, maxCol);

                    console.log('📊 Matrices procesadas:', {
                        getafe: this.getafeMatrix,
                        oviedo: this.oviedoMatrix,
                        maxRows: this.maxRows,
                        maxCols: this.maxCols
                    });
                },

                getMatrixCell(row, col, team) {
                    const matrix = team === 'getafe' ? this.getafeMatrix : this.oviedoMatrix;
                    return matrix[row] && matrix[row][col] ? matrix[row][col] : null;
                },

                calculateStats() {
                    const uniqueRows = new Set(this.allPlayers.map(p => p.row));
                    const uniqueCols = new Set(this.allPlayers.map(p => p.col));

                    this.stats = {
                        totalPlayers: this.allPlayers.length,
                        uniqueRows: uniqueRows.size,
                        uniqueCols: uniqueCols.size,
                        gridRange: `${Math.min(...uniqueRows)}-${Math.max(...uniqueRows)} x ${Math.min(...uniqueCols)}-${Math.max(...uniqueCols)}`
                    };
                },

                analyzeGrid() {
                    const getafePlayers = this.allPlayers.filter(p => p.team.toLowerCase().includes('getafe'));
                    const rows = getafePlayers.map(p => p.row);
                    const cols = getafePlayers.map(p => p.col);

                    const rowDistribution = {};
                    rows.forEach(row => {
                        rowDistribution[row] = (rowDistribution[row] || 0) + 1;
                    });

                    this.analysis = {
                        pattern: `${Math.min(...rows)}-${Math.max(...rows)} filas, ${Math.min(...cols)}-${Math.max(...cols)} columnas`,
                        rowRange: `${Math.min(...rows)} a ${Math.max(...rows)}`,
                        colRange: `${Math.min(...cols)} a ${Math.max(...cols)}`,
                        rowDistribution: rowDistribution
                    };

                    console.log('🧮 Análisis completado:', this.analysis);
                }
            }
        }
    </script>
</body>
</html>
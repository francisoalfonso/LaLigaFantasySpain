<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jugador - Fantasy La Liga Dashboard</title>

    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link rel="stylesheet" href="/style.css">
    <style>
        [x-cloak] { display: none !important; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div x-data="playerDetailApp()" x-init="init()" class="min-h-screen">
        <!-- Header Navigation -->
        <nav class="bg-gradient-to-r from-blue-900 via-purple-900 to-indigo-900 text-white p-4 shadow-lg">
            <div class="container mx-auto flex justify-between items-center">
                <div class="flex items-center space-x-4">
                    <a href="/" class="text-2xl font-bold flex items-center">
                        <i class="fas fa-futbol mr-2 text-yellow-400"></i>
                        Fantasy La Liga
                    </a>
                    <i class="fas fa-chevron-right text-gray-300"></i>
                    <span class="text-lg">Jugador</span>
                </div>
                <div class="flex space-x-4">
                    <a href="/bargains" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded-lg transition-colors flex items-center">
                        <i class="fas fa-gem mr-2"></i>
                        Chollos
                    </a>
                    <a href="/" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg transition-colors flex items-center">
                        <i class="fas fa-chart-line mr-2"></i>
                        Dashboard
                    </a>
                </div>
            </div>
        </nav>

        <!-- Loading State -->
        <div x-show="loading" class="flex items-center justify-center min-h-screen">
            <div class="text-center">
                <div class="animate-spin rounded-full h-32 w-32 border-b-2 border-blue-600 mx-auto"></div>
                <p class="mt-4 text-xl text-gray-600">Cargando datos del jugador...</p>
            </div>
        </div>

        <!-- Error State -->
        <div x-show="error" class="container mx-auto px-4 py-8">
            <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative">
                <strong class="font-bold">Error!</strong>
                <span class="block sm:inline" x-text="errorMessage"></span>
                <div class="mt-4">
                    <button @click="retry()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded">
                        <i class="fas fa-redo mr-2"></i>
                        Reintentar
                    </button>
                    <a href="/bargains" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded ml-2">
                        <i class="fas fa-arrow-left mr-2"></i>
                        Volver a Chollos
                    </a>
                </div>
            </div>
        </div>

        <!-- Player Content -->
        <div x-show="!loading && !error && player" x-cloak class="container mx-auto px-4 py-8">

            <!-- Player Header -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                <div class="flex flex-col lg:flex-row items-center lg:items-start space-y-6 lg:space-y-0 lg:space-x-8">

                    <!-- Player Photo -->
                    <div class="flex-shrink-0">
                        <div class="relative">
                            <img
                                :src="player?.player?.photo || '/placeholder-player.png'"
                                :alt="player?.player?.name || 'Jugador'"
                                class="w-32 h-32 lg:w-40 lg:h-40 rounded-full object-cover border-4 border-blue-200 shadow-lg"
                                onerror="this.src='/placeholder-player.png'"
                            >
                            <!-- Position Badge -->
                            <div class="absolute -bottom-2 -right-2 bg-blue-600 text-white px-3 py-1 rounded-full text-sm font-bold">
                                <span x-text="player?.games?.position || 'N/A'"></span>
                            </div>
                        </div>
                    </div>

                    <!-- Player Info -->
                    <div class="flex-grow text-center lg:text-left">
                        <h1 class="text-3xl lg:text-4xl font-bold text-gray-800 mb-2" x-text="player?.player?.name || 'Cargando...'"></h1>
                        <div class="flex flex-wrap justify-center lg:justify-start items-center gap-4 mb-4">
                            <div class="flex items-center">
                                <img
                                    :src="player?.team?.logo"
                                    :alt="player?.team?.name"
                                    class="w-6 h-6 mr-2"
                                >
                                <span class="text-lg font-semibold text-gray-700" x-text="player?.team?.name || 'N/A'"></span>
                            </div>
                            <span class="text-gray-600" x-text="player?.player?.age ? `${player.player.age} a√±os` : 'N/A'"></span>
                            <span class="text-gray-600" x-text="player?.player?.nationality || 'N/A'"></span>
                        </div>

                        <!-- Physical Stats -->
                        <div class="flex flex-wrap justify-center lg:justify-start gap-4 text-sm text-gray-600 mb-4">
                            <span x-show="player?.player?.height" x-text="`Altura: ${player?.player?.height}`"></span>
                            <span x-show="player?.player?.weight" x-text="`Peso: ${player?.player?.weight}`"></span>
                        </div>

                        <!-- Quick Stats -->
                        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                            <div class="bg-blue-50 p-3 rounded-lg text-center">
                                <div class="text-2xl font-bold text-blue-600" x-text="player?.games?.appearences || 0"></div>
                                <div class="text-sm text-gray-600">Partidos</div>
                            </div>
                            <div class="bg-green-50 p-3 rounded-lg text-center">
                                <div class="text-2xl font-bold text-green-600" x-text="player?.goals?.total || 0"></div>
                                <div class="text-sm text-gray-600">Goles</div>
                            </div>
                            <div class="bg-purple-50 p-3 rounded-lg text-center">
                                <div class="text-2xl font-bold text-purple-600" x-text="player?.goals?.assists || 0"></div>
                                <div class="text-sm text-gray-600">Asistencias</div>
                            </div>
                            <div class="bg-yellow-50 p-3 rounded-lg text-center">
                                <div class="text-2xl font-bold text-yellow-600" x-text="(player?.games?.rating ? parseFloat(player?.games?.rating).toFixed(1) : 'N/A')"></div>
                                <div class="text-sm text-gray-600">Rating</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex flex-wrap gap-4 mb-8">
                <button
                    @click="console.log('üîÆ Prediction button clicked'); loadPrediction()"
                    class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-lg transition-colors flex items-center"
                    :class="predictionLoading ? 'opacity-75' : ''"
                >
                    <i class="fas fa-crystal-ball mr-2" :class="predictionLoading ? 'animate-spin' : ''"></i>
                    <span x-text="predictionLoading ? 'Cargando...' : 'Obtener Predicci√≥n'"></span>
                </button>

                <button
                    @click="console.log('üìä Stats button clicked, current section:', showSection); showSection = showSection === 'stats' ? '' : 'stats'"
                    :disabled="false"
                    class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg transition-colors flex items-center"
                    :class="showSection === 'stats' ? 'bg-blue-800' : ''"
                >
                    <i class="fas fa-chart-bar mr-2"></i>
                    Estad√≠sticas Detalladas
                </button>

                <button
                    @click="toggleEvolution()"
                    :disabled="false"
                    class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-lg transition-colors flex items-center"
                    :class="showSection === 'evolution' ? 'bg-indigo-800' : ''"
                >
                    <i class="fas fa-chart-line mr-2"></i>
                    Evoluci√≥n de Valor
                </button>

                <button
                    @click="showSection = showSection === 'history' ? '' : 'history'"
                    :disabled="false"
                    class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg transition-colors flex items-center"
                    :class="showSection === 'history' ? 'bg-green-800' : ''"
                >
                    <i class="fas fa-history mr-2"></i>
                    Partidos Recientes
                </button>

                <button
                    @click="showSection = showSection === 'injuries' ? '' : 'injuries'"
                    :disabled="false"
                    class="bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-lg transition-colors flex items-center"
                    :class="showSection === 'injuries' ? 'bg-red-800' : ''"
                >
                    <i class="fas fa-heartbeat mr-2"></i>
                    Estado F√≠sico
                </button>
            </div>

            <!-- Prediction Section -->
            <div x-show="prediction" class="bg-gradient-to-r from-purple-100 to-indigo-100 border border-purple-200 rounded-xl p-6 mb-8">
                <h2 class="text-2xl font-bold text-purple-800 mb-4 flex items-center">
                    <i class="fas fa-crystal-ball mr-3"></i>
                    Predicci√≥n de Valor
                </h2>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Price Prediction -->
                    <div class="bg-white rounded-lg p-4 shadow-md">
                        <h3 class="font-semibold text-gray-700 mb-2">Precio Actual vs Predicci√≥n</h3>
                        <div class="flex items-center justify-between">
                            <div class="text-center">
                                <div class="text-xl font-bold text-gray-800" x-text="prediction?.currentPrice ? `${prediction.currentPrice}M` : 'N/A'"></div>
                                <div class="text-sm text-gray-600">Actual</div>
                            </div>
                            <i class="fas fa-arrow-right text-gray-400"></i>
                            <div class="text-center">
                                <div class="text-xl font-bold" :class="prediction?.priceChange > 0 ? 'text-green-600' : prediction?.priceChange < 0 ? 'text-red-600' : 'text-gray-600'" x-text="prediction?.predictedPrice ? `${prediction.predictedPrice}M` : 'N/A'"></div>
                                <div class="text-sm text-gray-600">Predicci√≥n</div>
                            </div>
                        </div>
                        <div class="mt-2 text-center">
                            <span
                                class="text-sm font-semibold"
                                :class="prediction?.priceChange > 0 ? 'text-green-600' : prediction?.priceChange < 0 ? 'text-red-600' : 'text-gray-600'"
                                x-text="prediction?.priceChange ? `${prediction.priceChange > 0 ? '+' : ''}${prediction.priceChange}M (${prediction.changePercentage}%)` : 'N/A'"
                            ></span>
                        </div>
                    </div>

                    <!-- Confidence & Recommendation -->
                    <div class="bg-white rounded-lg p-4 shadow-md">
                        <h3 class="font-semibold text-gray-700 mb-2">Recomendaci√≥n</h3>
                        <div class="text-center">
                            <div
                                class="inline-block px-3 py-1 rounded-full text-sm font-semibold mb-2"
                                :class="getActionColor(prediction?.recommendation?.action)"
                                x-text="prediction?.recommendation?.action || 'N/A'"
                            ></div>
                            <div class="text-sm text-gray-600 mb-2" x-text="prediction?.recommendation?.reason || 'N/A'"></div>
                            <div class="text-xs text-gray-500">
                                Confianza: <span :class="getConfidenceColor(prediction?.confidence)" x-text="prediction?.confidence ? `${prediction.confidence}%` : 'N/A'"></span>
                            </div>
                        </div>
                    </div>

                    <!-- Trend -->
                    <div class="bg-white rounded-lg p-4 shadow-md">
                        <h3 class="font-semibold text-gray-700 mb-2">Tendencia</h3>
                        <div class="text-center">
                            <div class="text-2xl mb-2" x-text="getTrendEmoji(prediction?.trend)"></div>
                            <div class="text-lg font-semibold capitalize" x-text="prediction?.trend || 'N/A'"></div>
                            <div class="text-sm text-gray-600 mt-2">
                                Generada: <span x-text="prediction?.generatedAt ? new Date(prediction.generatedAt).toLocaleDateString() : 'N/A'"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Prediction Factors -->
                <div class="mt-6">
                    <h3 class="font-semibold text-gray-700 mb-3">Factores de An√°lisis</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                        <template x-for="factor in (prediction?.factors || [])" :key="factor">
                            <div class="bg-white bg-opacity-50 px-3 py-1 rounded text-sm" x-text="factor"></div>
                        </template>
                    </div>
                </div>
            </div>

            <!-- Fantasy Value Evolution Section -->
            <div x-show="showSection === 'evolution'" class="bg-white rounded-xl shadow-lg p-6 mb-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                    <i class="fas fa-chart-line mr-3 text-indigo-600"></i>
                    Evoluci√≥n de Valor Fantasy - Temporada 2025-26
                </h2>

                <!-- Loading State for Evolution -->
                <div x-show="loadingEvolution" class="text-center py-8">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mx-auto"></div>
                    <p class="mt-4 text-gray-600">Cargando evoluci√≥n de valor...</p>
                </div>

                <!-- Evolution Chart and Data -->
                <div x-show="!loadingEvolution && evolution" x-init="if (showSection === 'evolution' && evolution) loadEvolutionData()">
                    <!-- Summary Cards -->
                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                        <div class="bg-gradient-to-r from-blue-50 to-blue-100 p-4 rounded-lg text-center">
                            <div class="text-2xl font-bold text-blue-600" x-text="evolution?.summary?.startValue ? `${evolution.summary.startValue}M` : 'N/A'"></div>
                            <div class="text-sm text-gray-600">Valor Inicial</div>
                        </div>
                        <div class="bg-gradient-to-r from-green-50 to-green-100 p-4 rounded-lg text-center">
                            <div class="text-2xl font-bold text-green-600" x-text="evolution?.summary?.currentValue ? `${evolution.summary.currentValue}M` : 'N/A'"></div>
                            <div class="text-sm text-gray-600">Valor Actual</div>
                        </div>
                        <div class="bg-gradient-to-r from-purple-50 to-purple-100 p-4 rounded-lg text-center">
                            <div class="text-2xl font-bold" :class="evolution?.summary?.totalPriceChange >= 0 ? 'text-green-600' : 'text-red-600'" x-text="evolution?.summary?.totalPriceChange ? `${evolution.summary.totalPriceChange >= 0 ? '+' : ''}${evolution.summary.totalPriceChange}M` : 'N/A'"></div>
                            <div class="text-sm text-gray-600">Cambio Total</div>
                        </div>
                        <div class="bg-gradient-to-r from-yellow-50 to-yellow-100 p-4 rounded-lg text-center">
                            <div class="text-2xl font-bold" :class="evolution?.summary?.totalPercentChange >= 0 ? 'text-green-600' : 'text-red-600'" x-text="evolution?.summary?.totalPercentChange ? `${evolution.summary.totalPercentChange >= 0 ? '+' : ''}${evolution.summary.totalPercentChange}%` : 'N/A'"></div>
                            <div class="text-sm text-gray-600">% Cambio</div>
                        </div>
                    </div>

                    <!-- Trend Indicator -->
                    <div class="bg-gray-50 rounded-lg p-4 mb-6">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <span class="text-2xl mr-3" x-text="getTrendEmoji(evolution?.trend)"></span>
                                <div>
                                    <div class="font-semibold text-gray-800">Tendencia Actual</div>
                                    <div class="text-sm text-gray-600 capitalize" x-text="evolution?.trend || 'N/A'"></div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="font-semibold text-gray-800" x-text="evolution?.summary?.totalFantasyPoints ? `${evolution.summary.totalFantasyPoints} puntos` : 'N/A'"></div>
                                <div class="text-sm text-gray-600">Total Fantasy</div>
                            </div>
                        </div>
                    </div>

                    <!-- Chart Container -->
                    <div class="bg-gray-50 rounded-lg p-4 mb-6">
                        <h3 class="font-semibold text-gray-700 mb-4">Gr√°fica de Evoluci√≥n</h3>
                        <div class="relative">
                            <canvas id="evolutionChart" width="400" height="200"></canvas>
                        </div>
                    </div>

                    <!-- Recent Performance Table -->
                    <div class="overflow-x-auto">
                        <h3 class="font-semibold text-gray-700 mb-4">√öltimas 10 Jornadas</h3>
                        <table class="min-w-full bg-white rounded-lg overflow-hidden">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="px-4 py-2 text-left text-sm font-semibold text-gray-600">Jornada</th>
                                    <th class="px-4 py-2 text-left text-sm font-semibold text-gray-600">Fecha</th>
                                    <th class="px-4 py-2 text-right text-sm font-semibold text-gray-600">Valor</th>
                                    <th class="px-4 py-2 text-right text-sm font-semibold text-gray-600">Cambio</th>
                                    <th class="px-4 py-2 text-right text-sm font-semibold text-gray-600">Rating</th>
                                    <th class="px-4 py-2 text-right text-sm font-semibold text-gray-600">Puntos</th>
                                    <th class="px-4 py-2 text-center text-sm font-semibold text-gray-600">Forma</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200">
                                <template x-for="gameweek in (evolution?.evolution?.slice(-10) || [])" :key="gameweek.gameweek">
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-4 py-2 text-sm font-medium text-gray-900" x-text="gameweek.gameweek"></td>
                                        <td class="px-4 py-2 text-sm text-gray-600" x-text="new Date(gameweek.date).toLocaleDateString()"></td>
                                        <td class="px-4 py-2 text-sm text-right font-semibold" x-text="`${gameweek.fantasyValue}M`"></td>
                                        <td class="px-4 py-2 text-sm text-right" :class="gameweek.priceChange >= 0 ? 'text-green-600' : 'text-red-600'" x-text="`${gameweek.priceChange >= 0 ? '+' : ''}${gameweek.priceChange}M`"></td>
                                        <td class="px-4 py-2 text-sm text-right" x-text="gameweek.rating"></td>
                                        <td class="px-4 py-2 text-sm text-right font-semibold" x-text="gameweek.fantasyPoints"></td>
                                        <td class="px-4 py-2 text-center">
                                            <span class="inline-block px-2 py-1 text-xs rounded-full" :class="getFormColor(gameweek.form)" x-text="gameweek.form"></span>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- No Evolution Data -->
                <div x-show="!loadingEvolution && !evolution" class="text-center py-8">
                    <i class="fas fa-chart-line text-gray-400 text-4xl mb-4"></i>
                    <p class="text-gray-600 mb-4">No hay datos de evoluci√≥n disponibles</p>
                    <button
                        @click="loadEvolutionData()"
                        class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-lg transition-colors"
                    >
                        <i class="fas fa-refresh mr-2"></i>
                        Cargar Evoluci√≥n
                    </button>
                </div>
            </div>

            <!-- Detailed Stats Section -->
            <div x-show="showSection === 'stats'" class="bg-white rounded-xl shadow-lg p-6 mb-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                    <i class="fas fa-chart-bar mr-3 text-blue-600"></i>
                    Estad√≠sticas Detalladas - Temporada 2025-26
                </h2>

                <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6">
                    <!-- Games Stats -->
                    <div class="bg-blue-50 rounded-lg p-4">
                        <h3 class="font-semibold text-blue-800 mb-3 flex items-center">
                            <i class="fas fa-gamepad mr-2"></i>
                            Partidos
                        </h3>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span>Jugados:</span>
                                <span class="font-semibold" x-text="player.games?.appearences || 0"></span>
                            </div>
                            <div class="flex justify-between">
                                <span>Titular:</span>
                                <span class="font-semibold" x-text="player.games?.lineups || 0"></span>
                            </div>
                            <div class="flex justify-between">
                                <span>Minutos:</span>
                                <span class="font-semibold" x-text="player.games?.minutes || 0"></span>
                            </div>
                            <div class="flex justify-between">
                                <span>Rating:</span>
                                <span class="font-semibold" x-text="player.games?.rating ? parseFloat(player.games.rating).toFixed(2) : 'N/A'"></span>
                            </div>
                        </div>
                    </div>

                    <!-- Goals & Assists -->
                    <div class="bg-green-50 rounded-lg p-4">
                        <h3 class="font-semibold text-green-800 mb-3 flex items-center">
                            <i class="fas fa-futbol mr-2"></i>
                            Goles y Asistencias
                        </h3>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span>Goles totales:</span>
                                <span class="font-semibold" x-text="player.goals?.total || 0"></span>
                            </div>
                            <div class="flex justify-between">
                                <span>Asistencias:</span>
                                <span class="font-semibold" x-text="player.goals?.assists || 0"></span>
                            </div>
                            <div class="flex justify-between">
                                <span>Por 90 min:</span>
                                <span class="font-semibold" x-text="player.games?.minutes > 0 ? ((player.goals?.total || 0) / player.games.minutes * 90).toFixed(2) : '0.00'"></span>
                            </div>
                        </div>
                    </div>

                    <!-- Cards -->
                    <div class="bg-yellow-50 rounded-lg p-4">
                        <h3 class="font-semibold text-yellow-800 mb-3 flex items-center">
                            <i class="fas fa-square mr-2"></i>
                            Tarjetas
                        </h3>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span>Amarillas:</span>
                                <span class="font-semibold text-yellow-600" x-text="player.cards?.yellow || 0"></span>
                            </div>
                            <div class="flex justify-between">
                                <span>Rojas:</span>
                                <span class="font-semibold text-red-600" x-text="player.cards?.red || 0"></span>
                            </div>
                        </div>
                    </div>

                    <!-- Passes (if available) -->
                    <div x-show="player.passes" class="bg-purple-50 rounded-lg p-4">
                        <h3 class="font-semibold text-purple-800 mb-3 flex items-center">
                            <i class="fas fa-exchange-alt mr-2"></i>
                            Pases
                        </h3>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span>Total:</span>
                                <span class="font-semibold" x-text="player.passes?.total || 0"></span>
                            </div>
                            <div class="flex justify-between">
                                <span>Precisi√≥n:</span>
                                <span class="font-semibold" x-text="player.passes?.accuracy ? player.passes.accuracy + '%' : 'N/A'"></span>
                            </div>
                            <div class="flex justify-between">
                                <span>Clave:</span>
                                <span class="font-semibold" x-text="player.passes?.key || 0"></span>
                            </div>
                        </div>
                    </div>

                    <!-- Dribbles (if available) -->
                    <div x-show="player.dribbles" class="bg-indigo-50 rounded-lg p-4">
                        <h3 class="font-semibold text-indigo-800 mb-3 flex items-center">
                            <i class="fas fa-running mr-2"></i>
                            Regates
                        </h3>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span>Intentos:</span>
                                <span class="font-semibold" x-text="player.dribbles?.attempts || 0"></span>
                            </div>
                            <div class="flex justify-between">
                                <span>Exitosos:</span>
                                <span class="font-semibold" x-text="player.dribbles?.success || 0"></span>
                            </div>
                            <div class="flex justify-between">
                                <span>Efectividad:</span>
                                <span class="font-semibold" x-text="(player.dribbles?.attempts > 0) ? Math.round((player.dribbles.success / player.dribbles.attempts) * 100) + '%' : 'N/A'"></span>
                            </div>
                        </div>
                    </div>

                    <!-- Penalties (if available) -->
                    <div x-show="player.penalty" class="bg-red-50 rounded-lg p-4">
                        <h3 class="font-semibold text-red-800 mb-3 flex items-center">
                            <i class="fas fa-dot-circle mr-2"></i>
                            Penaltis
                        </h3>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span>Marcados:</span>
                                <span class="font-semibold" x-text="player.penalty?.scored || 0"></span>
                            </div>
                            <div class="flex justify-between">
                                <span>Fallados:</span>
                                <span class="font-semibold" x-text="player.penalty?.missed || 0"></span>
                            </div>
                            <div class="flex justify-between">
                                <span>Total:</span>
                                <span class="font-semibold" x-text="player.penalty?.total || 0"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Games Section -->
            <div x-show="showSection === 'history'" class="bg-white rounded-xl shadow-lg p-6 mb-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                    <i class="fas fa-history mr-3 text-green-600"></i>
                    Partidos Recientes
                </h2>

                <div x-show="recentGames && recentGames.length > 0">
                    <div class="space-y-4">
                        <template x-for="game in recentGames" :key="game.fixture.id">
                            <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50 transition-colors">
                                <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between space-y-2 lg:space-y-0">
                                    <div class="flex items-center space-x-4">
                                        <div class="text-sm text-gray-600" x-text="new Date(game.fixture.date).toLocaleDateString()"></div>
                                        <div class="flex items-center space-x-2">
                                            <img :src="game.teams.home.logo" :alt="game.teams.home.name" class="w-6 h-6">
                                            <span class="font-semibold" x-text="game.teams.home.name"></span>
                                            <span class="text-gray-600">vs</span>
                                            <img :src="game.teams.away.logo" :alt="game.teams.away.name" class="w-6 h-6">
                                            <span class="font-semibold" x-text="game.teams.away.name"></span>
                                        </div>
                                        <div class="font-bold" x-text="`${game.goals.home} - ${game.goals.away}`"></div>
                                    </div>
                                    <div x-show="game.player_stats" class="text-sm text-gray-600">
                                        Rating: <span class="font-semibold" x-text="game.player_stats?.games?.rating || 'N/A'"></span>
                                        | Min: <span class="font-semibold" x-text="game.player_stats?.games?.minutes || 0"></span>
                                        | G: <span class="font-semibold" x-text="game.player_stats?.goals?.total || 0"></span>
                                        | A: <span class="font-semibold" x-text="game.player_stats?.goals?.assists || 0"></span>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>

                <div x-show="!recentGames || recentGames.length === 0" class="text-center py-8">
                    <i class="fas fa-info-circle text-gray-400 text-4xl mb-4"></i>
                    <p class="text-gray-600">No hay informaci√≥n de partidos recientes disponible</p>
                </div>
            </div>

            <!-- Injuries Section -->
            <div x-show="showSection === 'injuries'" class="bg-white rounded-xl shadow-lg p-6 mb-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                    <i class="fas fa-heartbeat mr-3 text-red-600"></i>
                    Estado F√≠sico y Lesiones
                </h2>

                <div x-show="injuries && injuries.length > 0">
                    <div class="space-y-4">
                        <template x-for="injury in injuries" :key="injury.date">
                            <div class="border border-red-200 rounded-lg p-4 bg-red-50">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <div class="font-semibold text-red-800" x-text="injury.type"></div>
                                        <div class="text-sm text-red-600" x-text="injury.reason"></div>
                                    </div>
                                    <div class="text-sm text-red-600" x-text="new Date(injury.date).toLocaleDateString()"></div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>

                <div x-show="!injuries || injuries.length === 0" class="text-center py-8">
                    <i class="fas fa-check-circle text-green-500 text-4xl mb-4"></i>
                    <p class="text-green-600 font-semibold">¬°Sin lesiones reportadas!</p>
                    <p class="text-gray-600">El jugador est√° disponible para jugar</p>
                </div>
            </div>

        </div>
    </div>

    <script>
        function playerDetailApp() {
            return {
                // State
                loading: true,
                error: false,
                errorMessage: '',
                playerId: null,
                player: null,
                prediction: null,
                loadingPrediction: false,
                recentGames: [],
                injuries: [],
                showSection: '',
                evolution: null,
                loadingEvolution: false,
                evolutionChart: null,
                predictionLoading: false,

                // Initialize
                init() {
                    this.playerId = this.getPlayerIdFromUrl();
                    if (this.playerId) {
                        this.loadPlayerData();
                    } else {
                        this.showError('ID de jugador no v√°lido');
                    }
                },

                getPlayerIdFromUrl() {
                    const pathParts = window.location.pathname.split('/');
                    return pathParts[pathParts.length - 1];
                },

                async loadPlayerData() {
                    try {
                        this.loading = true;
                        this.error = false;

                        const response = await fetch(`/api/laliga/laliga/player/${this.playerId}/details`);
                        const result = await response.json();

                        if (result.success) {
                            this.player = result.data;
                            this.recentGames = result.data.recentGames || [];
                            this.injuries = result.data.injuries || [];
                            console.log('‚úÖ Datos del jugador cargados:', this.player);
                        } else {
                            this.showError(result.error || 'Error cargando datos del jugador');
                        }

                    } catch (error) {
                        console.error('‚ùå Error cargando jugador:', error);
                        this.showError('Error de conexi√≥n');
                    } finally {
                        this.loading = false;
                    }
                },

                loadPrediction() {
                    console.log('üîÆ Iniciando predicci√≥n...');

                    // Prevenir clics m√∫ltiples
                    if (this.predictionLoading) {
                        console.log('‚ö†Ô∏è Predicci√≥n ya en curso, ignorando clic');
                        return;
                    }

                    // Activar indicador de carga
                    this.predictionLoading = true;

                    // Ejecutar fetch FUERA del contexto de Alpine usando setTimeout
                    const playerId = this.playerId;
                    const self = this;

                    console.log('‚è≥ Ejecutando fetch en background...');

                    setTimeout(async () => {
                        try {
                            console.log('üì° Fetch iniciado para player:', playerId);
                            const response = await fetch(`/api/predictions/player/${playerId}`);
                            const result = await response.json();

                            if (result.success) {
                                self.prediction = result.data;
                                console.log('‚úÖ Predicci√≥n cargada exitosamente');
                            } else {
                                console.log('‚ùå Error en respuesta:', result.error);
                                alert('Error: ' + result.error);
                            }
                        } catch (error) {
                            console.log('‚ùå Error de fetch:', error.message);
                            alert('Error de conexi√≥n. Int√©ntalo m√°s tarde.');
                        } finally {
                            // Resetear estado de carga
                            self.predictionLoading = false;
                            console.log('üîÑ predictionLoading reseteado a false');
                        }
                    }, 10);

                    // Funci√≥n retorna inmediatamente - Alpine no se bloquea
                    console.log('üîÑ loadPrediction retornando inmediatamente');
                },

                showError(message) {
                    this.error = true;
                    this.errorMessage = message;
                    this.loading = false;
                },

                retry() {
                    this.loadPlayerData();
                },

                // Helper methods
                getTrendEmoji(trend) {
                    if (!trend) return '‚ùì';
                    const emojis = {
                        'rising': 'üìà',
                        'falling': 'üìâ',
                        'stable': '‚û°Ô∏è'
                    };
                    return emojis[trend] || '‚ùì';
                },

                getConfidenceColor(confidence) {
                    if (!confidence && confidence !== 0) return 'text-gray-600';
                    if (confidence >= 80) return 'text-green-600 font-semibold';
                    if (confidence >= 60) return 'text-yellow-600 font-semibold';
                    return 'text-red-600 font-semibold';
                },

                getActionColor(action) {
                    if (!action) return 'bg-gray-100 text-gray-800';
                    const colors = {
                        'BUY': 'bg-green-100 text-green-800',
                        'SELL': 'bg-red-100 text-red-800',
                        'HOLD': 'bg-gray-100 text-gray-800'
                    };
                    return colors[action] || 'bg-gray-100 text-gray-800';
                },

                getFormColor(form) {
                    if (!form) return 'bg-gray-100 text-gray-800';
                    const colors = {
                        'excellent': 'bg-green-100 text-green-800',
                        'good': 'bg-blue-100 text-blue-800',
                        'average': 'bg-yellow-100 text-yellow-800',
                        'poor': 'bg-red-100 text-red-800'
                    };
                    return colors[form] || 'bg-gray-100 text-gray-800';
                },

                async loadEvolutionData() {
                    if (!this.playerId) return;

                    try {
                        this.loadingEvolution = true;

                        const response = await fetch(`/api/evolution/player/${this.playerId}`);
                        const result = await response.json();

                        if (result.success) {
                            this.evolution = result.data;
                            console.log('üìà Evoluci√≥n cargada:', this.evolution);

                            // Crear gr√°fica cuando los datos est√©n disponibles
                            this.$nextTick(() => {
                                setTimeout(() => {
                                    this.createEvolutionChart();
                                }, 200);
                            });
                        } else {
                            console.error('Error cargando evoluci√≥n:', result.error);
                            alert('‚ùå Error: ' + (result.error || 'No se pudo cargar la evoluci√≥n'));
                        }

                    } catch (error) {
                        console.error('‚ùå Error cargando evoluci√≥n:', error);
                        alert('‚ùå Error de conexi√≥n: No se pudo obtener la evoluci√≥n');
                    } finally {
                        this.loadingEvolution = false;
                    }
                },

                toggleEvolution() {
                    console.log('üîÑ Toggle evolution clicked, current section:', this.showSection);
                    if (this.showSection === 'evolution') {
                        this.showSection = '';
                        console.log('‚úÖ Hiding evolution section');
                    } else {
                        this.showSection = 'evolution';
                        console.log('üìä Showing evolution section');
                        if (!this.evolution) {
                            console.log('üìà No evolution data, loading...');
                            this.loadEvolutionData();
                        } else {
                            console.log('‚úÖ Evolution data already exists');
                        }
                    }
                },

                createEvolutionChart() {
                    if (!this.evolution || !this.evolution.evolution) {
                        console.log('‚ùå No evolution data for chart');
                        return;
                    }

                    const ctx = document.getElementById('evolutionChart');
                    if (!ctx) {
                        console.log('‚ùå Canvas element not found');
                        return;
                    }

                    console.log('üìä Creating chart with data:', this.evolution.evolution.length, 'points');

                    // Destruir gr√°fica anterior si existe
                    if (this.evolutionChart) {
                        this.evolutionChart.destroy();
                    }

                    const gameweeks = this.evolution.evolution.map(e => `J${e.gameweek}`);
                    const values = this.evolution.evolution.map(e => e.fantasyValue);
                    const points = this.evolution.evolution.map(e => e.fantasyPoints);

                    this.evolutionChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: gameweeks,
                            datasets: [
                                {
                                    label: 'Valor Fantasy (M)',
                                    data: values,
                                    borderColor: 'rgb(99, 102, 241)',
                                    backgroundColor: 'rgba(99, 102, 241, 0.1)',
                                    tension: 0.4,
                                    fill: true,
                                    yAxisID: 'y'
                                },
                                {
                                    label: 'Puntos Fantasy',
                                    data: points,
                                    borderColor: 'rgb(34, 197, 94)',
                                    backgroundColor: 'rgba(34, 197, 94, 0.1)',
                                    tension: 0.4,
                                    yAxisID: 'y1'
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            interaction: {
                                mode: 'index',
                                intersect: false,
                            },
                            scales: {
                                x: {
                                    display: true,
                                    title: {
                                        display: true,
                                        text: 'Jornadas'
                                    },
                                    ticks: {
                                        maxTicksLimit: 10
                                    }
                                },
                                y: {
                                    type: 'linear',
                                    display: true,
                                    position: 'left',
                                    title: {
                                        display: true,
                                        text: 'Valor Fantasy (M)',
                                        color: 'rgb(99, 102, 241)'
                                    },
                                    ticks: {
                                        color: 'rgb(99, 102, 241)'
                                    }
                                },
                                y1: {
                                    type: 'linear',
                                    display: true,
                                    position: 'right',
                                    title: {
                                        display: true,
                                        text: 'Puntos Fantasy',
                                        color: 'rgb(34, 197, 94)'
                                    },
                                    ticks: {
                                        color: 'rgb(34, 197, 94)'
                                    },
                                    grid: {
                                        drawOnChartArea: false,
                                    },
                                }
                            },
                            plugins: {
                                title: {
                                    display: true,
                                    text: `Evoluci√≥n Fantasy - ${this.evolution.playerName}`
                                },
                                legend: {
                                    display: true,
                                    position: 'top'
                                },
                                tooltip: {
                                    callbacks: {
                                        afterLabel: function(context) {
                                            const gameweek = context.parsed.x;
                                            const evolutionData = this.evolution.evolution[gameweek];
                                            if (evolutionData) {
                                                return [
                                                    `Rating: ${evolutionData.rating}`,
                                                    `Forma: ${evolutionData.form}`,
                                                    `Cambio: ${evolutionData.priceChange >= 0 ? '+' : ''}${evolutionData.priceChange}M`
                                                ];
                                            }
                                            return [];
                                        }.bind(this)
                                    }
                                }
                            }
                        }
                    });
                }
            };
        }
    </script>
</body>
</html>